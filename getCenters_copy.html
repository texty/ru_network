<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RU-NETWORK</title>
    <script src="lib/d3v5.min.js"></script>
    <script src="lib/underscore.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">


    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,300;0,400;0,700;1,300;1,400&display=swap" rel="stylesheet">
    <script src="lib/d3v5.min.js"></script>
    <!-- скрипт з грідом трохи поправила відповідно до того, який був на версії 3. Він краще працює, враховує розмір одиниці і кількість колонок -->
    <script src="lib/d3_v4_grid.js"></script>

</head>

<style>
    body {
        margin: 0;
        background-color: black;
    }  

    .tick text{
        fill: silver;
    }

    circle.grid-circle {
        stroke: grey;
        stroke-width: 6px;
        fill-opacity: .25;
        stroke-opacity: 0.5;
        pointer-events: none;
    }

    svg text {
        font-family: 'Roboto Mono', monospace;
    }
    
    .point {
        cursor: pointer;
    }


    /*  Switch buttons */
    .switch-wrapper {
        background-color: #191919;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px 0;
    }

    .switch {
        display: flex;
        justify-content: center;
    }

    .switch label {
        display: flex;
        align-items: center;
        cursor: pointer;
    }

    .switch button {
        margin-right: 10px;
        background-color: #191919;
        border: 1px solid white;
        color: white;
        padding: 5px;
        font-size: 18px;
        font-family: 'Roboto Mono', monospace;
        cursor: pointer;
    }

    .switch button.active {
        background-color: white;
        border: 0px;
        color: #191919;
    }

    .eye-switch {
        cursor: pointer;       
    }

    #is_ru {
        margin-right: 50px;
    }

    input[type="checkbox"] {
        content: url('img/oko.svg');
        appearance: none;
        display: inline-block;
        width: 30px;
        height: 30px;
    }

    input[type="checkbox"]:checked {
        content: url('img/oko2.svg');
    }

    .bar-switch {
        cursor: pointer;
        fill: silver;
    }

    .bar-switch.active {
        text-decoration-line: underline;
        text-underline-offset: 2px;
    }


    /* Bar chart */
    .label {
        fill-opacity: 0.7;
        text-anchor: middle;
    }

    .tick-left, .tick-right {
        text-anchor: middle;
    }



    /* Modal Content */
    #test-tooltip {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width:100%;
        max-width: 400px;
        height: 400px;
        border-radius: 50%;
        background-color: #000000cf;
        border: 5px solid #404040;
        z-index: 1000;
        display: none;
        font-family: 'Roboto Mono', monospace;
    }

    #test-tooltip p {
        color: silver;      
        margin: 10px auto;
        
    }

    #test-tooltip a {
        color: silver;
    }
    
    .modal-content {  
        /* direction: rtl;     */      
        margin: 50px auto auto auto;              
        width: 70%; 
        height: 250px;        
        overflow-y: auto; /* Add the ability to scroll */
        text-align: left;
        padding-left: 5px;
    }

    /* Hide scrollbar for Chrome, Safari and Opera */
    .modal-content::-webkit-scrollbar {
        width:3px;
    /* display: none; */
}

.modal-content::-webkit-scrollbar-track-piece {
    background: black;
}

.modal-content::-webkit-scrollbar-thumb {
  background: silver;
  border-radius: 10px;
}


    /* The Close Button */
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: red;
        text-decoration: none;
        cursor: pointer;
    }

    #modal-icon {
        position:absolute;
    
        display:block;
        margin: 50px;   
          /*   transform: scale(1.5); */
        animation: orbit 95s linear infinite;   
        z-index: -1;     
    }

    #entity-name {
        font-size: 18px;
        font-weight: bold;
        display: block;
    }

    #entity-name, #entity-country, #entity-local-name {
        text-align: center;
    }

    a.entity-link {
        text-decoration: none;
        font-weight: bold;
    }

    
    a.entity-link:after {
        display: inline-block;
        content: '';
        -webkit-mask-size: contain;
        mask-size: contain;
        background-color: currentColor;
        -webkit-mask: url(img/link.svg) no-repeat 50% 50%;
        mask: url(img/link.svg) no-repeat 50% 50%;
        margin: -0.3em -0.2em -0.25em 0.05em;
        width: 1.1em;
        height: 1.1em;
    }

    @-webkit-keyframes orbit { 
        from { -webkit-transform:rotate(0deg) } 
        to { -webkit-transform:rotate(360deg) } 
    }
    @-moz-keyframes orbit { 
        from { -moz-transform:rotate(0deg) } 
        to { -moz-transform:rotate(360deg) } 
    }
    
</style>


<body>
    <div class='switch-wrapper'>
        <div class="switch" style="padding-right: 20px; border-right: 1px solid silver;">
        <button id='change_by_country' class='active'>КРАЇНИ</button>
        <!-- <button id='change_by_sphere_grid'>ВИДИ ДІЯЛЬНОСТІ</button> --> 
        <button id='change_by_sphere_nested'>ВИДИ ДІЯЛЬНОСТІ_new</button>
        <!-- <button id='change_by_sphere'>ВИДИ ДІЯЛЬНОСТІ_old</button>
        <button id='change_by_ideology'>ПРАВІ/ЛІВІ</button> -->
    </div>
    <div class="switch" style='margin-left: 20px;'>
        <p style='color: white;font-size: 20px; font-family: "Roboto Mono", monospace; display: flex;'>
            <label>Росіяни <input id='is_ru' class='eye-switch' type="checkbox"/></label>
            <label>Спостерегачі <input id='is_watcher' class='eye-switch' type="checkbox"/></label>
        </p>
    </div>    
    </div>
    

        <div id="test-tooltip" class="modal">
            <svg id='modal-icon' x="0px" y="0px" width="300px" height="300px">                    
                <path id="modal-icon-path" fill="white" d="M46.9,9.3c-0.5-2.1-2.5-4.4-6.4-4c-7.1,0.8-9.9,5.9-11.8,11.3c-1.3,3.5-0.9,7.3-0.4,9.5l0,0c0,0,0,0,0,0.1
                    c0,0.2,0.1,0.4,0.1,0.6c0.3,1.8,0.3,6.9-8.7,6.7c0,0-1.1,0.8,0.1,1c1,0.2,5.2,1.2,8.4-0.9c0.8-0.5,1.3-1.1,1.6-1.7
                    c-1.2,3.3-3.9,8.6-9.2,9.3c0,0-1.2,1,0.5,1.1c1.4,0.1,9-3.1,11.2-10.7c0.2,2.7,0,7.8-3.6,9.7c0,0-1.3,1.7,0.7,1.2
                    c2.1-0.5,6.1-4.5,5.4-12.4c2.5-1,2.6-4.6,2.6-6.9c0-1.5,2.1-4.3,2.1-4.3C40,18,42,16.2,44,15.5C46.2,14.7,47.5,11.9,46.9,9.3z"/>
            </svg>
            <!-- Modal content -->
            <div class="modal-content">
                <span class="close">&times;</span>
                
                <p id='entity-name'>Імʼя </p>
                <p id='entity-country' style='font-style:italic'></p>
                <p id='entity-local-name'></p> 
                    
              <div style='max-height: 100%; overflow-y: auto;'>
                <p><span id='entity-descriptrion'></span> <a id="entity-wiki" class='entity-link'></a></p>
                <p><a id='entity-money' class='entity-link' href='' target="_blank">Отримував гроші / зв'язок із російськими структурами </a> </p>
                <p><a id='entity-watcher' class='entity-link'href='' target="_blank">Спостерігач / незаконний перетин кордон </a> </p>
                <p><a id='entity-statements' class='entity-link' href='' target="_blank">Проросійські заяви </a> </p>
            </div>
            </div>        
        </div>

    <svg id="scatterplot"></svg>

    <script src='js/figures.js'></script>
   <!--  <script src='drawBars.js'></script> -->
   <script>
       
   </script>
    <script>
        //поріг переходу до viewbox, щоб влазило на мобільну версію.
        var TRESHOLD = 1150;

        var MARGINS = { top: 180, right: 90, bottom: 20, left: 70 },
            WIDTH = window.innerWidth > TRESHOLD ? window.innerWidth * 0.98 : TRESHOLD,
            innerWIDTH = WIDTH - MARGINS.left - MARGINS.right,
            HEIGHT = 800,
            DIAMETER = 1200;

        var colorSheme = d3.scaleOrdinal()
            .domain(['політика', "громадська", "медіа", "експерт", 'бізнес', "освіта та культура", "церква"])
            .range(["#9F5D36", "#7983A9", "#835F74",  "#7B2C3F", "#E07E8F", "#2A947D", "#E6DC83" ])
            .unknown("silver");

        //var shapes = [bacillus_p_1, bacillus_p_2, bacillus_p_3, bacillus_p_4, bacillus_p_5, bacillus_p_6, bacillus_o_1, bacillus_o_2, bacillus_o_3, bacillus_o_4, bacillus_o_5, bacillus_o_6];
        var shapes_people = [bacillus_p_1, bacillus_p_2, bacillus_p_3, bacillus_p_4, bacillus_p_5, bacillus_p_6];
        var shapes_org = [bacillus_o_1, bacillus_o_2, bacillus_o_3, bacillus_o_4, bacillus_o_5, bacillus_o_6];

        var is_ru = false;
        var is_watcher = false;
        var is_people = false;
        var is_organization = false;
        var screen = "first";

        

        d3.csv("data/test_full_data_new.csv").then(function (df) {
            /* потрібно для pack layout */
            df.forEach(function (d) { d.size = 1; })


            var svg = d3.select("#scatterplot")
                .attr("width", window.innerWidth > TRESHOLD ? WIDTH : "100%")
                .attr("height", window.innerWidth > TRESHOLD ? HEIGHT : "100%")
                .attr("viewBox", function () {
                    return window.innerWidth < TRESHOLD ? `0 0 1150 1950` : null
                });

            //основна візуалізація    
            var c_group = svg
                .append("g")
                .attr("id", "main-vis")
                .attr("transform", `translate(160, 180)`);

            //легенда із бар-чартами
            var chart = svg
                .append("g")
                .attr("id", "bar-chart-vis")
                .attr('class', 'chart')
                .attr("transform", `translate(75,75)`);

            window['chart'] = chart;

            var grid = d3.grid()
                .padding([25, 70]);

            var packLayout = d3.pack()
                .size([WIDTH, HEIGHT])
                .padding(function (d) {
                    return d.height > 1 ? 20 / 0.35 : 3
                });


            /* переключалка екранів */
            prepare_data_countries_vis("country", 120);

            d3.select('#change_by_country').on("click", function () {
                screen = "first";
                prepare_data_countries_vis("country", 120);
                drawBars(barchart_data)
            });

            d3.select('#change_by_sphere_nested').on("click", function () {
                screen = "second";
                prepare_data_nested_pack();
                drawBars(barchart_data2);
            })


            d3.select('#change_by_sphere').on("click", function () {
                screen = "second";
                prepare_data_sphere_vis("domain");
                drawBars(barchart_data2);
            })


            d3.select('#change_by_sphere_grid').on("click", function () {
                //prepare_data_countries_vis("domain", 165);
                prepare_data_countries_vis("entity_type", 190);
                drawBars(barchart_data2)
            });

            d3.select('#change_by_ideology').on("click", function () {
                prepare_data_sphere_vis("ideological_platform");
                drawBars(barchart_data2)
            });

            /* включити-виключити окремі категорії (росіяни/спостерігачі тощо) */
            d3.select("#is_ru").on("click", function () {
                is_watcher = false;
                is_ru = !is_ru;
                d3.select("#is_watcher").property("checked", false);

                if (is_ru) {
                    d3.selectAll("path.point").style("fill-opacity", function (d) {
                        return d.collaboration_type === 'росіяни' ? 1 : 0.2
                    })
                } else {
                    d3.selectAll("path.point").style("fill-opacity", 1)
                }
            });

            d3.select("#is_watcher").on("click", function () {
                is_ru = false;
                is_watcher = !is_watcher;
                d3.select("#is_ru").property("checked", false);
                if (is_watcher) {
                    d3.selectAll("path.point").style("fill-opacity", function (d) {
                        return d.observer_border_violation != '' ? 1 : 0.2
                    })
                } else {
                    d3.selectAll("path.point").style("fill-opacity", 1)
                }
            });



            //ideological_platform     

            function prepare_data_countries_vis(nest_var, setR) {

                var nest = d3.nest()
                    .key(function (d) { return d[nest_var] })
                    .entries(df)
                    .sort(function (a, b) { return b.values.length - a.values.length });

                var radius = setR;
                var innerRadius = radius - 18;
                var nodeSize = radius * 2;

                //к-ть колонок для гріда
                var cols_default = Math.floor(innerWIDTH / nodeSize)
                var cols_amount = cols_default > 1 ? cols_default : 1;

                grid.cols(cols_amount)
                    .nodeSize([nodeSize, nodeSize])

                //додаємо пусті обʼєкти в грід на початоку, щоб потім їх прибрати і зсунути грід на 2 обʼєкти
                let skip1 = { key: 'empty' }
                let skip2 = { key: 'empty' }
                nest.unshift(skip1);
                nest.unshift(skip2);


                //визначаємо позиція великих кілець
                var data_for_grid = grid(nest)
                    .filter(function (d) { return d.key != 'empty' });

                data_for_grid.forEach(function (d) { d.r = radius })

                //рахуємо висоту svg
                var rows_amount = Math.ceil((data_for_grid.length + 2) / cols_amount);
                var calculated_height = (rows_amount * nodeSize) + (rows_amount * 70 + 100)

                svg.attr("height", function () {
                    return window.innerWidth > TRESHOLD ? calculated_height : "100%";
                })

                //робимо набір з x та y координатами для кожного елементу гріда
                var countries_cx = {};
                var countries_cy = {};
                for (var i = 0; i < data_for_grid.length; i++) {
                    countries_cx[data_for_grid[i].key] = data_for_grid[i].x
                    countries_cy[data_for_grid[i].key] = data_for_grid[i].y
                }

                //розраховуємо x та y координату кожної бактерії в межах коло відповідно до гріду.
                df.forEach(function (d) {
                    //формула рендомна точка на диску
                    var randAngle = Math.random() * Math.PI * 2;
                    var randRadius = Math.sqrt(~~(Math.random() * innerRadius * innerRadius));;
                    var randX = countries_cx[d[nest_var]] + randRadius * Math.cos(randAngle);
                    var randY = countries_cy[d[nest_var]] + randRadius * Math.sin(randAngle);

                    d.x = randX;
                    d.y = randY;
                    d.r = 5
                });



                doSimulation(df, data_for_grid)

            }

            /* екран 2 */
            function prepare_data_nested_pack() {

                var vCsvData = df.map(function (d, i) {
                    if (d.domain === "політика") {
                        return { id: "c" + i, parentId: d.ideological_platform }
                    } else {
                        return { id: "c" + i, parentId: d.domain }
                    }
                });

                vCsvData.unshift({ id: "root", parentId: '' })

                vCsvData.push({ id: "права", parentId: 'політика' })
                vCsvData.push({ id: "ліва", parentId: 'політика' })
                vCsvData.push({ id: "центриська", parentId: 'політика' })
                vCsvData.push({ id: "інші", parentId: 'політика' })

                vCsvData.push({ id: "політика", parentId: 'root' })
                vCsvData.push({ id: "медіа", parentId: 'root' })
                vCsvData.push({ id: "експерт", parentId: 'root' })
                vCsvData.push({ id: "бізнес", parentId: 'root' })
                vCsvData.push({ id: "церква", parentId: 'root' })
                vCsvData.push({ id: "освіта та культура", parentId: 'root' })
                vCsvData.push({ id: "громадська", parentId: 'root' })
              /*   vCsvData.push({ id: "освіта", parentId: 'root' }) */

                vCsvData.forEach(function (d) { d.size = 1 });
                var stratify = d3.stratify();
                var vData = stratify(vCsvData);

                var vWidth = window.innerWidth > 1400 ? 1000 : 850;
                var packLayoutLeftMargin = window.innerWidth > 1400 ? 350 :
                            window.innerWidth > 1300 ? 200 : 120;

                var vLayout = d3.pack()
                    .size([vWidth, vWidth])
                    .padding(function (d) {
                       // return d.height >= 2 ? 80 : 30
                        return d.height >= 2 & d.height != 4 ? 80 : 30
                    });

                // Layout + Data
                var vRoot = d3.hierarchy(vData).sum(function (d) { return d.data.size; });
                var vNodes = vRoot.descendants();
                vLayout(vRoot);

                var data_for_grid = vRoot.descendants()
                    .filter(function (d) { return d.height === 2 | d.height === 1 })
                    .map(function (d) {
                        return {
                            "key": d.data.data.id,
                            "depth": d.data.depth,
                            "height": d.data.height,
                            "x": d.y + packLayoutLeftMargin,
                            "y": d.x - vWidth/3.5,
                            "r": d.r

                        }
                    });

                    console.log(data_for_grid)

                var domain_cx = {};
                var domain_cy = {};
                var domain_r = {};

                for (var i = 0; i < data_for_grid.length; i++) {
                    domain_cx[data_for_grid[i].key] = data_for_grid[i].x
                    domain_cy[data_for_grid[i].key] = data_for_grid[i].y
                    domain_r[data_for_grid[i].key] = data_for_grid[i].r
                }

                df.forEach(function (d) {
                    var NEST_VAR = d.domain === "політика" ? d.ideological_platform : d.domain;
                    let innerRadius = domain_r[NEST_VAR] - 20;

                    //формула рендомна точка на диску
                    var randAngle = Math.random() * Math.PI * 2;
                    var randRadius = Math.sqrt(~~(Math.random() * innerRadius * innerRadius));;
                    var randX = domain_cx[NEST_VAR] + randRadius * Math.cos(randAngle);
                    var randY = domain_cy[NEST_VAR] + randRadius * Math.sin(randAngle);
                    d.x = randX;
                    d.y = randY;
                    d.r = 4.5
                });

                doSimulation(df, data_for_grid)


            }


            function prepare_data_sphere_vis(nest_var) {

                var nest = d3.nest()
                    .key(function (d) { return d[nest_var] })
                    /*  .key(function(d) {                        
                         return d.ideological_platform; })  */
                    .entries(df)
                    .sort(function (a, b) { return b.values.length - a.values.length })
                    .map(function (group) {
                        return {
                            name: group.key,
                            children: group.values,
                            size: group.values.length
                        }
                    });

                var data_2 = {
                    "name": "root",
                    "children": nest
                }



                var rootNode = d3.hierarchy(data_2);
                rootNode.sum(function (d) { return d.size; });
                packLayout(rootNode);

                var data_for_grid = rootNode.descendants()
                    .filter(function (d) { return d.depth === 1 })
                    .map(function (d) {
                        return {
                            "key": d.data.name,
                            "x": d.x,
                            "y": d.y - 180,
                            "r": d.r
                        }
                    });

                var domain_cx = {};
                var domain_cy = {};
                var domain_r = {};

                for (var i = 0; i < data_for_grid.length; i++) {
                    domain_cx[data_for_grid[i].key] = data_for_grid[i].x
                    domain_cy[data_for_grid[i].key] = data_for_grid[i].y
                    domain_r[data_for_grid[i].key] = data_for_grid[i].r
                }

                df.forEach(function (d) {
                    let innerRadius = domain_r[d[nest_var]] - 30

                    //формула рендомна точка на диску
                    var randAngle = Math.random() * Math.PI * 2;
                    var randRadius = Math.sqrt(~~(Math.random() * innerRadius * innerRadius));;
                    var randX = domain_cx[d[nest_var]] + randRadius * Math.cos(randAngle);
                    var randY = domain_cy[d[nest_var]] + randRadius * Math.sin(randAngle);
                    d.x = randX;
                    d.y = randY;
                    d.r = 5
                });

                doSimulation(df, data_for_grid)
            }


            //робимо симуляцію
            function doSimulation(row_data, grid_data) {

                let sim = d3.forceSimulation(row_data);
                sim.force("collision", d3.forceCollide(d => d.r));
                sim.on('tick', drawPlot);
                setTimeout(function () {
                    sim.stop()
                }, 5000)

                function drawPlot() {

                    //грід 
                    var circles = c_group.selectAll("circle.grid-circle").data(grid_data);
                    var labels = c_group.selectAll("text").data(grid_data);

                    circles.exit().remove()

                    circles
                        .enter()
                        .append('circle')
                        .attr("class", "grid-circle")
                        .attr("cx", function (d) { return d.x + 10 })
                        .attr("cy", function (d) { return d.y + 7 })
                        .attr("r", function (d) { return d.r  });

                    circles
                        .transition()
                        .duration(200)
                        .attr("class", "grid-circle")
                        .attr("cx", function (d) { return d.x + 10 })
                        .attr("cy", function (d) { return d.y + 7 })
                        .attr("r", function (d) { return d.r  });

                    // підписи до гріда    
                    labels.exit().remove()

                    labels.enter()
                        .append('text')
                        .attr("x", function (d) { return d.x + 10 })
                        .attr("y", function (d) { return d.y - d.r })
                        .text(function (d) { return d.key })
                        .style("fill", function (d) {
                            return colorSheme(d.key)
                        })
                        .style("text-anchor", "middle");

                    labels
                        .transition()
                        .duration(200)
                        .attr("x", function (d) { return d.x + 10 })
                        .attr("y", function (d) { return d.y - d.r })
                        .text(function (d) { return d.key })
                        .style("fill", function (d) { return colorSheme(d.key) })
                        .style("text-anchor", "middle");


                    //точки    
                    let points = c_group.selectAll("path.point").data(row_data);

                    points.enter()
                        .append("path")
                        .attr("class", "point")
                        .attr("d", function (d) { return d.entity_type === 'організація' ? shapes_org[randBetween(0, 5)] : shapes_people[randBetween(0, 5)] })
                        .attr("transform", function (d) { return `translate(${d.x}, ${d.y})scale(0.35)` })
                        .attr("r", function (d) { return d.r })
                        .style("fill", function (d) { return colorSheme(d.domain) })
                        .on("click", function (d) {
                            d3.select("#test-tooltip").style("display", "block");
                            d3.select("#modal-icon-path")
                                .attr("d", function(){ 
                                    return d.entity_type === "організація"? bacillus_org : bacillus_people2; })
                                .style("fill", colorSheme(d.domain));
                            d3.select("#entity-name").text(d.name_ukr).style("color", colorSheme(d.domain));;
                            d3.select("#entity-local-name").text(d.name_local);
                            d3.select("#entity-country").text(d.country);
                            d3.select("#entity-descriptrion").text(d.short_description);
                            if(d.russian_money){
                                d3.select("#entity-money")
                                    .attr('href', d.russian_money)
                                    .style('display', "block");
                            } else {
                                d3.select("#entity-money").style('display', "none");
                            }

                            if(d.observer_border_violation){
                                d3.select("#entity-watcher")
                                    .attr('href', d.observer_border_violation)
                                    .style('display', "block");
                            } else {
                                d3.select("#entity-watcher")
                                    .style('display', "none");
                            }

                            if(d.prorussian_statements){
                                d3.select("#entity-statements")
                                    .attr('href', d.prorussian_statements)
                                    .style('display', "block");
                            } else {
                                d3.select("#entity-statements")
                                    .style('display', "none");
                            }
                           
                            
                        });
                /*         <p><span id='entity-name'>Імʼя </span> <span id='entity-local-name'></span></p>
                <p id='entity-country'>Країна</p>
                <p><span id='entity-descriptrion'>Опис </span> <a id="entity-wiki"> Детальніше </a></p>
                <p><a id='entity-money' href='' target="_blank">Отримував гроші/ зв'язок із російськими структурами</a></p>
                <p><a id='entity-watcher' href='' target="_blank">Спостерігач, незаконний перетин кордону</a></p>
                <p><a id='entity-statements' href='' target="_blank">Проросійські заяви</a></p> */

                    //rotate(${Math.random() * Math.PI * 2 })
                    //rotate(${ Math.random() * 360} )
                    points
                        .transition()
                        .duration(200)
                        .attr("class", "point")
                        .attr("transform", function (d) { return `translate(${d.x}, ${d.y})scale(0.35)` })

                }
            }

            /* ----------------------------------------
            ----------------- Бар-чарт -----------------
            ------------------------------------------  */

            var barchart_data = d3.nest()
                .key(function (d) { return d.domain; })
                .rollup(function (leaves) {
                    let g1 = leaves.filter(function (d) { return d.entity_type === "людина" });
                    let g2 = leaves.filter(function (d) { return d.entity_type === "організація" })
                    return { "val1": g1.length, "val2": g2.length }
                })
                .entries(df)
                .map(function (group) {
                    return { "cat": group.key, "val1": group.value.val1, "val2": group.value.val2 }
                });

            var barchart_data2 = d3.nest()
                .key(function (d) { return d.country; })
                .rollup(function (leaves) {
                    let g1 = leaves.filter(function (d) { return d.entity_type === "людина" });
                    let g2 = leaves.filter(function (d) { return d.entity_type === "організація" })
                    return { "val1": g1.length, "val2": g2.length }
                })
                .entries(df)
                .map(function (group) {
                    return { "cat": group.key, "val1": group.value.val1, "val2": group.value.val2 }
                });

            var chart_width = 300,
                chart_height = 300;

            var сhart_x = d3.scaleLinear()
                .range([0, chart_width]);

            var chart_y = d3.scaleBand();
         
            //кнопки-переключалки   
            chart.append("path")
                .attr("d", bacillus_people2)
                .attr("transform", "translate(-40,-70)scale(0.8)")
                .attr("fill", "silver");
            
            chart.append("text")
                .text("Люди")
                .attr("transform", "translate(-10,-12)")
                .attr('class', "bar-switch")
                .style("text-anchor", "middle")               
                .on("click", function () {
                    d3.selectAll("path.point").style("fill-opacity", 1);
                    d3.selectAll('.bar-switch').classed("active", false);
                    d3.select(this).classed("active", true);
                    if (screen === "first") {
                        barchart_data.sort(function (a, b) { return a.val1 - b.val1 });
                        drawBars(barchart_data)
                    } else {
                        barchart_data2.sort(function (a, b) { return a.val1 - b.val1 });
                        drawBars(barchart_data2)
                    }
                    is_people = !is_people;
                    is_organization = false;
                    if (is_people) {
                        d3.selectAll("path.point").style("fill-opacity", function (d) {
                            return d.entity_type === 'людина' ? 1 : 0.2
                        })
                    } else {
                        d3.selectAll("path.point").style("fill-opacity", 1)
                    }



                });;

            //організації
            chart.append("path")
                .attr("d", bacillus_org)
                .attr("transform", `translate(${chart_width},-70)scale(0.8)`)
                .attr("fill", "silver");

            chart.append("text")
                .text("Організації")
                .attr("transform", `translate(${chart_width - 20}, -12)`)
                .attr('class', "bar-switch")
                .style("text-anchor", "start")              
                .on("click", function () {
                    d3.selectAll("path.point").style("fill-opacity", 1);
                    d3.selectAll('.bar-switch').classed("active", false);
                    d3.select(this).classed("active", true);
                    if (screen === "first") {
                        barchart_data.sort(function (a, b) { return a.val2 - b.val2 });
                        drawBars(barchart_data)
                    } else {
                        barchart_data2.sort(function (a, b) { return a.val2 - b.val2 });
                        drawBars(barchart_data2)
                    }

                    is_organization = !is_organization;
                    is_people = false;
                    if (is_organization) {
                        d3.selectAll("path.point").style("fill-opacity", function (d) {
                            return d.entity_type === 'організація' ? 1 : 0.2
                        })
                    } else {
                        d3.selectAll("path.point").style("fill-opacity", 1)
                    }

                });

            chart.append("text")
                .text("Загалом")
                .attr("transform", `translate(160, -10)`)
                .attr('class', "bar-switch active")
                .style("text-anchor", "middle")                              
                .on("click", function () {
                    d3.selectAll('.bar-switch').classed("active", false);
                    d3.select(this).classed("active", true);
                    d3.selectAll("path.point").style("fill-opacity", 1);
                    is_people = false;
                    is_organization = false;
                    d3.select("#is_ru").property("checked", false);
                    d3.select("#is_watcher").property("checked", false);
                })
            

            drawBars(barchart_data)

            function drawBars(dat) {

                var new_height = dat.length * 35;

                let xdomain_start = dat === barchart_data ? d3.max(dat, function (d) { return d.val1 }) : 
                    d3.max(dat, function (d) { return d.val2 });

                сhart_x
                    .domain([-xdomain_start, xdomain_start ])

                chart_y
                    .domain(dat.map(function (d) { return d.cat }))
                    .range([new_height, 10])
                    .padding(0.7);


                var left_bars = chart.selectAll("rect.left").data(dat);
                var right_bars = chart.selectAll("rect.right").data(dat);
                var bar_labels = chart.selectAll("text.label").data(dat);
                var bar_ticks_left = chart.selectAll("text.tick-left").data(dat);
                var bar_ticks_right = chart.selectAll("text.tick-right").data(dat);

                //ліві стовбчики
                left_bars.exit().remove()
                
                left_bars.enter().append("rect")
                    .attr("x", function (d) { return сhart_x(-d.val1); })
                    .attr("y", function (d) { return chart_y(d.cat) + chart_y.bandwidth() / 3 })
                    .attr("class", "left")
                    .attr("width", function (d) { return сhart_x(0) - сhart_x(-d.val1) })
                    .attr("height", chart_y.bandwidth() / 3)
                    .style("fill", function (d) { return colorSheme(d.cat) })
                    .attr("rx", 2)
                    .attr("ry", 2);

                left_bars.transition().duration(200)
                    .attr("x", function (d) { return сhart_x(-d.val1); })
                    .attr("y", function (d) { return chart_y(d.cat) + chart_y.bandwidth() / 3 })
                    .attr("width", function (d) { return сhart_x(0) - сhart_x(-d.val1) })
                    .style("fill", function (d) {return colorSheme(d.cat) });


                //праві стовбчики
                right_bars.exit().remove();

                right_bars.enter().append("rect")
                    .attr("x", сhart_x(0))
                    .attr("y", function (d) { return chart_y(d.cat) })
                    .attr("class", "right")
                    .attr("width", function (d) { return сhart_x(d.val2) - (chart_width / 2) })
                    .attr("height", chart_y.bandwidth())
                    .style("fill", function (d) { return colorSheme(d.cat) })
                    .attr("rx", 4)
                    .attr("ry", 4);

                right_bars.transition().duration(200)
                    .attr("x", сhart_x(0))
                    .attr("y", function (d) { return chart_y(d.cat) }) 
                    .attr("width", function (d) { return сhart_x(d.val2) - (chart_width / 2) })                 
                    .style("fill", function (d) { return colorSheme(d.cat) })
                   

                //підписи категорій    
                bar_labels.exit().remove();

                bar_labels.enter().append("text")
                    .attr("class", "label")
                    .attr("x", сhart_x(0))
                    .attr("y", function (d) { return chart_y(d.cat) - 5 })
                    .text(function (d) { return d.cat })
                    .style("fill", function (d) {  return colorSheme(d.cat)  })                    

                bar_labels.transition().duration(200)
                    .attr("x", сhart_x(0))
                    .attr("y", function (d) { return chart_y(d.cat) - 5 })
                    .text(function (d) { return d.cat })
                    .style("fill", function (d) { return colorSheme(d.cat) });                   


                //цифри ліворуч    
                bar_ticks_left.exit().remove();

                bar_ticks_left.enter().append("text")
                    .attr("class", "tick-left")
                    .attr("x", function (d) { return сhart_x(-d.val1) - 20 })
                    .attr("y", function (d) { return chart_y(d.cat) + 10 })
                    .style("fill", function (d) { return colorSheme(d.cat) })                   
                    .text(function (d) { return d.val1 })

                bar_ticks_left.transition().duration(200)
                    .attr("x", function (d) { return сhart_x(-d.val1) - 20 })
                    .attr("y", function (d) { return chart_y(d.cat) + 10 })
                    .style("fill", function (d) { return colorSheme(d.cat) })                  
                    .text(function (d) { return d.val1 });

                //цифри праворуч    
                bar_ticks_right.exit().remove();

                bar_ticks_right.enter().append("text")
                    .attr("class", "tick-right")
                    .attr("x", function (d) { return сhart_x(d.val2) + 20 })
                    .attr("y", function (d) { return chart_y(d.cat) + 10 })
                    .style("fill", function (d) { return colorSheme(d.cat) })                    
                    .text(function (d) { return d.val2 })

                bar_ticks_right.transition().duration(200)
                    .attr("x", function (d) { return сhart_x(d.val2) + 20  })
                    .attr("y", function (d) { return chart_y(d.cat) + 10 })
                    .style("fill", function (d) { return colorSheme(d.cat) })                   
                    .text(function (d) { return d.val2 })

            } 
        });

        var modal = document.getElementById("test-tooltip");       

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        
     

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
        }


        function randBetween(min, max) {
            return Math.floor(Math.random() * (max - min + 1) + min);
        }

    </script>

</body>

</html>